<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SongMatch</title>
  <meta name="theme-color" content="#0b0f14" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='48'>üéµ</text></svg>">

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; background:#0b0f14; color:#fff; margin:0; }

    .topbar { position:sticky; top:0; z-index:50; backdrop-filter: blur(6px);
      background:rgba(10,14,20,.7); border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; gap:8px; padding:10px 12px; }
    .brand { font-weight:800; letter-spacing:.3px; }
    .spacer { flex:1; }
    .tb-btn { background:#1f2a3a; color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; }

    .gate, .auth { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; z-index:9999; }
    .card { background:#121822; padding:24px; border-radius:14px; width:min(420px,92vw); }
    .card h1, .card h2 { margin:0 0 8px 0; }
    .field { display:flex; flex-direction:column; gap:6px; margin:10px 0; }
    .field input { padding:12px 14px; border-radius:10px; border:none; background:#0f1520; color:#fff; }
    .btn { padding:12px 14px; border-radius:10px; border:none; background:#7aa2ff; color:#fff; font-weight:700; cursor:pointer; }
    .muted { opacity:.75; font-size:14px; }

    html:not(.gate-ok) .app { display:none; }
    html.gate-ok .gate { display:none; }
    html.auth-ok .auth { display:none; }

    .wrap { max-width:820px; margin:0 auto; padding:16px; }
    .panel { background:#121822; margin:20px 0; padding:20px; border-radius:14px; }

    .swipe-wrap { position:relative; height:420px; display:flex; align-items:center; justify-content:center; }
    .swipe-card {
      position:absolute; width:min(360px,92vw); height:380px; border-radius:16px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.35); background:#0f1520;
      transition: transform .25s ease, opacity .25s ease; animation: popin .25s ease;
    }
    @keyframes popin { from{ transform:scale(.96); opacity:.0 } to{ transform:scale(1); opacity:1 } }
    .swipe-card iframe { width:100%; height:100%; border:0; display:block; }
    .badge { position:absolute; top:12px; padding:6px 10px; border-radius:8px; font-weight:800; letter-spacing:.5px; opacity:0; transition:opacity .12s ease; pointer-events:none; }
    .badge.like { left:12px; background:rgba(46,204,113,.9); }
    .badge.nope { right:12px; background:rgba(231,76,60,.9); }

    .gesture-top { position:absolute; left:0; right:0; top:0; height:72%; pointer-events:auto; touch-action:none; z-index:6; }
    .playbar { margin-top:12px; display:flex; justify-content:center; }
    .playbar-btn { width:min(360px,92vw); border-radius:999px; padding:14px 16px; background:#1f2a3a; color:#fff; border:none; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25); }
    .playbar-btn:active { transform: translateY(1px); }

    .topprog{position:sticky;top:0;height:3px;background:#1f2a3a}
    .topprog>i{display:block;height:100%;background:#7aa2ff;width:0%}

    .playlist { display:grid; gap:10px; }
    iframe.embed-small { width:100%; height:80px; border-radius:10px; }
    .tiny { font-size:12px; opacity:.7; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">SongMatch</div>
    <div class="spacer"></div>
    <button id="logoutBtn" class="tb-btn">üö™ Abmelden</button>
  </div>
  <div class="topprog"><i id="tp"></i></div>

  <div class="gate">
    <div class="card">
      <h1>Zugang</h1>
      <p class="muted">Bitte Code eingeben:</p>
      <div class="field"><input id="gateCode" type="password" placeholder="Code (z. B. 1235)" /></div>
      <button id="gateBtn" class="btn">Weiter</button>
    </div>
  </div>

  <div class="auth">
    <div class="card">
      <h2 id="authTitle">Anmelden</h2>
      <div class="field"><input id="username" placeholder="Username (ohne E-Mail)" /></div>
      <div class="field"><input id="password" type="password" placeholder="Passwort" /></div>
      <button id="loginBtn" class="btn">Anmelden</button>
      <div class="muted" style="margin-top:10px">
        <span id="authSwitchText">Noch kein Account?</span>
        <button id="authSwitch" class="btn" style="background:transparent;border:1px solid #7aa2ff;">Account erstellen</button>
      </div>
      <p id="authMsg" class="muted" style="margin-top:6px"></p>
    </div>
  </div>

  <div class="app">
    <div class="wrap">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <h2 style="margin:0">N√§chster Song</h2>
          <div class="tiny" id="progressInfo">‚Äì</div>
        </div>
        <div id="songArea" class="muted" style="min-height:420px">l√§dt Songs ‚Ä¶</div>
        <div class="playbar"><button id="playBarBtn" class="playbar-btn">‚ñ∂Ô∏è Tippen zum Abspielen</button></div>
      </div>
      <div class="panel">
        <h2 style="margin:0 0 10px 0">Gemeinsame Playlist</h2>
        <div id="playlist" class="playlist"></div>
        <p id="plHint" class="muted">Hier erscheinen Songs automatisch, sobald ihr beide ‚ù§Ô∏è geswiped habt.</p>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const ACCESS_CODE = '1235';
      const KEY = 'songmatch:ok';
      function unlock(){ document.documentElement.classList.add('gate-ok'); localStorage.setItem(KEY,'1'); }
      if(localStorage.getItem(KEY)==='1'){ unlock(); }
      document.getElementById('gateBtn').onclick = () => {
        const code = document.getElementById('gateCode').value.trim();
        if(code===ACCESS_CODE){ unlock(); } else { alert("Falscher Code"); }
      };
    })();
  </script>

  <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = { /* ... your firebase config unchanged ... */ };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- UI refs
    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authTitle = document.getElementById('authTitle');
    const authSwitch = document.getElementById('authSwitch');
    const authSwitchText = document.getElementById('authSwitchText');
    const authMsg = document.getElementById('authMsg');

    const songArea=document.getElementById("songArea");
    const playlistEl=document.getElementById("playlist");
    const plHint=document.getElementById("plHint");
    const progressInfo=document.getElementById("progressInfo");
    const topProg=document.getElementById("tp");
    const playBarBtn=document.getElementById("playBarBtn");

    const updatePlayBtn=(playing)=>{playBarBtn.textContent=playing?'‚è∏Ô∏è Tippen zum Pausieren':'‚ñ∂Ô∏è Tippen zum Abspielen';};

    // --- Auth UI
    let signUpMode=false;
    const toEmail=u=>`${u.trim().toLowerCase()}@sm.local`;
    authSwitch.onclick=()=>{ signUpMode=!signUpMode; authTitle.textContent=signUpMode?'Account erstellen':'Anmelden'; loginBtn.textContent=signUpMode?'Erstellen & Anmelden':'Anmelden'; authSwitchText.textContent=signUpMode?'Schon ein Account?':'Noch kein Account?'; authSwitch.textContent=signUpMode?'Anmelden':'Account erstellen'; };
    loginBtn.onclick=async()=>{ const u=usernameEl.value.trim(); const p=passwordEl.value; if(!u||!p){authMsg.textContent='Username + Passwort eingeben';return;} authMsg.textContent='...'; try{ if(signUpMode){ const cred=await createUserWithEmailAndPassword(auth,toEmail(u),p); await updateProfile(cred.user,{displayName:u}); await setDoc(doc(db,'users',cred.user.uid),{username:u,createdAt:serverTimestamp()},{merge:true}); } else { await signInWithEmailAndPassword(auth,toEmail(u),p);} document.documentElement.classList.add('auth-ok'); authMsg.textContent=''; }catch(e){ authMsg.textContent='Fehler: '+(e.code||e.message);} };
    logoutBtn.onclick=async()=>{ await signOut(auth); document.documentElement.classList.remove('auth-ok'); };

    // --- Firestore refs
    const poolRef=doc(db,"config","pool");
    function progressRef(uid){ return doc(db,"progress",uid); }

    let uid=null,songs=[],index=0;
    const CLIENT_ID_KEY='songmatch:cid';
    let clientId=localStorage.getItem(CLIENT_ID_KEY)||Math.random().toString(36).slice(2); localStorage.setItem(CLIENT_ID_KEY,clientId);

    onAuthStateChanged(auth,async(user)=>{ if(!user){document.documentElement.classList.remove('auth-ok');return;} uid=user.uid; document.documentElement.classList.add('auth-ok'); const psnap=await getDoc(progressRef(uid)); index=psnap.exists()?(psnap.data().index||0):0; await ensurePoolHasEnough(100); await reloadSongsFromPool(); renderCurrent(); onSnapshot(progressRef(uid),snap=>{ if(!snap.exists())return; const d=snap.data(); if(d.by===clientId)return; const ni=d.index||0; if(ni!==index){index=ni;renderCurrent();}}); });

    // --- Spotify API helpers
    async function getToken(){ const r=await fetch("https://reasorr-github-io.vercel.app/api/token"); return (await r.json()).access_token; }
    async function searchTracks(token,q,limit=50){ const url=`https://api.spotify.com/v1/search?type=track&limit=${limit}&q=${encodeURIComponent(q)}`; const r=await fetch(url,{headers:{Authorization:'Bearer '+token}}); if(!r.ok)return[]; const j=await r.json(); return (j.tracks?.items||[]).map(t=>t.id).filter(Boolean);}
    async function filterByPopularity(token,ids,minPop=85){const keep=[];for(let i=0;i<ids.length;i+=50){const slice=ids.slice(i,i+50);const r=await fetch(`https://api.spotify.com/v1/tracks?ids=${slice.join(',')}`,{headers:{Authorization:'Bearer '+token}});if(!r.ok)continue;const j=await r.json();for(const t of j.tracks||[]){if(t?.popularity>=minPop)keep.push(t.id);}}return keep;}

    // mirror-safe playlist
    async function getPlaylistTrackIdsAllowed(token,pid,market='DE',limit=100){const url=`https://api.spotify.com/v1/playlists/${pid}/tracks?limit=${limit}&market=${market}&fields=items(track(id))`;const r=await fetch(url,{headers:{Authorization:'Bearer '+token}});if(!r.ok)return[];const j=await r.json();return(j.items||[]).map(it=>it.track?.id).filter(Boolean);}

    async function buildBatch(){ const token=await getToken(); let pool=[]; // 1) optional mirror playlist(s)
      const mirror=['4yNfFAuHcSgzbcSm6q5QDu']; for(const pid of mirror){ pool.push(...await getPlaylistTrackIdsAllowed(token,pid)); }
      // 2) search+popularity
      const queries=['genre:pop year:2024-2025','genre:hip-hop year:2024-2025','genre:latin year:2024-2025','genre:dance year:2024-2025','genre:afrobeat year:2024-2025']; for(const q of queries){ pool.push(...await searchTracks(token,q,50)); }
      pool=await filterByPopularity(token,Array.from(new Set(pool)),85); return pool; }

    async function ensurePoolHasEnough(min=100){const snap=await getDoc(poolRef);let ids=snap.exists()?(snap.data().ids||[]):[];if(ids.length>=min)return;const batch=await buildBatch();ids=[...new Set([...ids,...batch])];await setDoc(poolRef,{ids,updatedAt:serverTimestamp()},{merge:true});}
    async function reloadSongsFromPool(){const snap=await getDoc(poolRef);songs=snap.exists()?(snap.data().ids||[]):[];}

    // --- Swipe + playback
    let embedCtrl=null; window.onSpotifyIframeApiReady=(IFrameAPI)=>{ /* ready */ };
    function mountSwipeCard(trackId){ songArea.innerHTML=`<div class="swipe-wrap"><div class="swipe-card" id="swipeCard"><div class="badge like" id="badgeLike">LIKE</div><div class="badge nope" id="badgeNope">NOPE</div><div id="spotifyHost" style="width:100%;height:100%"></div><div class="gesture-top" id="gestureTop"></div></div></div>`;
      window.onSpotifyIframeApiReady=(API)=>{ API.createController(document.getElementById('spotifyHost'),{uri:`spotify:track:${trackId}`},c=>{embedCtrl=c;c.addListener('playback_update',e=>updatePlayBtn(!e.data.isPaused));});};}
    function renderCurrent(){ if(!songs.length){songArea.textContent="Lade...";return;} mountSwipeCard(songs[index]); progressInfo.textContent=`Song ${index+1}/${songs.length}`; topProg.style.width=((index+1)/songs.length*100)+"%"; }
    async function vote(val){const id=songs[index];await setDoc(doc(db,"votes",id),{[uid]:val,updatedAt:serverTimestamp()},{merge:true});await runTransaction(db,async(tx)=>{const ref=progressRef(uid);const s=await tx.get(ref);const cur=s.exists()?(s.data().index||0):0;tx.set(ref,{index:cur+1,by:clientId,updatedAt:serverTimestamp()},{merge:true});}); index++;renderCurrent();}
    playBarBtn.onclick=()=>{embedCtrl?.togglePlay();};
    window.addEventListener('keydown',e=>{if(e.key==='ArrowRight')vote('like');if(e.key==='ArrowLeft')vote('dislike');if(e.key==='p')playBarBtn.click();});
  </script>
</body>
</html>
