<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SongMatch</title>
  <style>
    body { font-family: sans-serif; background:#0b0f14; color:white; margin:0; padding:0; }
    .gate { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; z-index:9999; }
    .gate-card { background:#121822; padding:20px; border-radius:12px; text-align:center; }
    .gate-card input, .gate-card button { padding:10px; margin:5px; border-radius:6px; }
    .gate-card button { background:#7aa2ff; color:white; border:none; cursor:pointer; }
    html:not(.gate-ok) .app { display:none; }
    html.gate-ok .gate { display:none; }

    .card { background:#121822; margin:20px; padding:20px; border-radius:12px; }
    .center { text-align:center; }
    button.vote { font-size:18px; padding:10px 20px; margin:10px; border:none; border-radius:8px; cursor:pointer; }
    .like { background:#2ecc71; }
    .dislike { background:#e74c3c; }
    iframe { border:none; border-radius:8px; }
    .playlist { display:grid; gap:10px; }
  </style>
</head>
<body>
  <!-- Zugangscode -->
  <div class="gate">
    <div class="gate-card">
      <h1>Zugang</h1>
      <p>Bitte Code eingeben:</p>
      <input id="gateCode" type="password" placeholder="Code" />
      <button id="gateBtn">Weiter</button>
    </div>
  </div>

  <!-- App -->
  <div class="app">
    <div class="card center">
      <h2>N√§chster Song</h2>
      <div id="songArea"></div>
      <button id="likeBtn" class="vote like">‚ù§Ô∏è Like</button>
      <button id="dislikeBtn" class="vote dislike">‚úñÔ∏è Dislike</button>
    </div>

    <div class="card">
      <h2>Gemeinsame Playlist</h2>
      <div id="playlist" class="playlist"></div>
    </div>
  </div>

  <!-- Zugangscode Script -->
  <script>
    (function(){
      const ACCESS_CODE = '1235';
      const KEY = 'songmatch:ok';
      function unlock(){ document.documentElement.classList.add('gate-ok'); localStorage.setItem(KEY,'1'); }
      if(localStorage.getItem(KEY)==='1'){ unlock(); }
      document.getElementById('gateBtn').onclick = () => {
        const code = document.getElementById('gateCode').value.trim();
        if(code===ACCESS_CODE){ unlock(); } else { alert("Falscher Code"); }
      };
    })();
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // üîë Deine Firebase Config einsetzen
    const firebaseConfig = {
      apiKey: "AIzaSyCOYv05V2jXiDYPjc1MlT_WdpgLfW4aJJo",
      authDomain: "songmatch-850c7.firebaseapp.com",
      projectId: "songmatch-850c7",
      storageBucket: "songmatch-850c7.firebasestorage.app",
      messagingSenderId: "139459584433",
      appId: "1:139459584433:web:df99f2c2a15cd6eed41d90"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    signInAnonymously(auth).catch(console.error);

    // --- feste Songliste ---
    const songs = [
      "4uLU6hMCjMI75M1A2tKUQC", // Eminem - Without Me
      "3n3Ppam7vgaVa1iaRUc9Lp", // Red Hot Chili Peppers - Californication
      "6habFhsOp2NvshLv26DqMb", // Ed Sheeran - Shape of You
      "0e7ipj03S05BNilyu5bRzt", // Dua Lipa - Levitating
      "7qiZfU4dY1lWllzX7mPBI3"  // Ed Sheeran - Perfect
    ];

    let index = 0;
    let uid = null;

    auth.onAuthStateChanged(user => { if(user) uid = user.uid; });

    const songArea = document.getElementById("songArea");
    const likeBtn = document.getElementById("likeBtn");
    const dislikeBtn = document.getElementById("dislikeBtn");
    const playlistEl = document.getElementById("playlist");

    function showSong(i){
      if(i>=songs.length){ 
        songArea.innerHTML="<p>üé∂ Keine weiteren Songs!</p>"; 
        return; 
      }
      const id = songs[i];
      songArea.innerHTML = `<iframe src="https://open.spotify.com/embed/track/${id}" width="300" height="380"></iframe>`;
    }

    // Vote speichern + lokal weiterschalten
    async function vote(val){
      const id = songs[index];
      const ref = doc(db, "votes", id);

      await setDoc(ref, { [uid]: val, updatedAt: serverTimestamp() }, { merge: true });

      // lokaler Wechsel zum n√§chsten Song
      index++;
      showSong(index);
    }

    likeBtn.onclick = () => vote("like");
    dislikeBtn.onclick = () => vote("dislike");

    // Playlist Listener (gemeinsam)
    songs.forEach(id => {
      const ref = doc(db, "votes", id);
      onSnapshot(ref, snap => {
        if(!snap.exists()) return;
        const data = snap.data();
        const vals = Object.values(data).filter(v => v==="like"||v==="dislike");
        if(vals.length >= 2 && vals.every(v => v==="like")){
          if(!document.getElementById("pl-"+id)){
            playlistEl.innerHTML += `<iframe id="pl-${id}" src="https://open.spotify.com/embed/track/${id}" width="300" height="80"></iframe>`;
          }
        }
      });
    });

    // Start
    showSong(index);
  </script>
</body>
</html>
