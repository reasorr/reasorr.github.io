<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SongMatch</title>
  <meta name="theme-color" content="#0b0f14">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='48'>üéµ</text></svg>">
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; background:#0b0f14; color:#fff; margin:0; }

    .topbar { position:sticky; top:0; z-index:50; backdrop-filter: blur(6px); background:rgba(10,14,20,.7); border-bottom:1px solid rgba(255,255,255,.06); display:flex; align-items:center; gap:8px; padding:10px 12px; }
    .brand { font-weight:800; letter-spacing:.3px; }
    .spacer { flex:1; }
    .tb-btn { background:#1f2a3a; color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; }

    .gate, .auth { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; z-index:9999; }
    .card { background:#121822; padding:24px; border-radius:14px; width:min(420px,92vw); }
    .card h1, .card h2 { margin:0 0 8px 0; }
    .field { display:flex; flex-direction:column; gap:6px; margin:10px 0; }
    .field input { padding:12px 14px; border-radius:10px; border:none; background:#0f1520; color:#fff; }
    .btn { padding:12px 14px; border-radius:10px; border:none; background:#7aa2ff; color:#fff; font-weight:700; cursor:pointer; }
    .muted { opacity:.75; font-size:14px; }
    html:not(.gate-ok) .app { display:none; }
    html.gate-ok .gate { display:none; }
    html.auth-ok .auth { display:none; }

    .wrap { max-width:820px; margin:0 auto; padding:16px; }
    .panel { background:#121822; margin:20px 0; padding:20px; border-radius:14px; }

    .swipe-wrap { position:relative; height:420px; display:flex; align-items:center; justify-content:center; }
    .swipe-card { position:absolute; width:min(360px,92vw); height:380px; border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.35); background:#0f1520; transition: transform .25s ease, opacity .25s ease; }
    .swipe-card iframe { width:100%; height:100%; border:0; display:block; }
    .badge { position:absolute; top:12px; padding:6px 10px; border-radius:8px; font-weight:800; letter-spacing:.5px; opacity:0; transition:opacity .12s ease; pointer-events:none; }
    .badge.like { left:12px; background:rgba(46,204,113,.9); }
    .badge.nope { right:12px; background:rgba(231,76,60,.9); }

    .gesture-top { position:absolute; left:0; right:0; top:0; height:72%; pointer-events:auto; touch-action:none; z-index:6; }
    .playbar { margin-top:12px; display:flex; justify-content:center; }
    .playbar-btn { width:min(360px,92vw); border-radius:999px; padding:14px 16px; background:#1f2a3a; color:#fff; border:none; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25); }

    .playlist { display:grid; gap:10px; }
    iframe.embed-small { width:100%; height:80px; border-radius:10px; }
    .tiny { font-size:12px; opacity:.7; }

    .topprog{position:sticky;top:0;height:3px;background:#1f2a3a}
    .topprog>i{display:block;height:100%;background:#7aa2ff;width:0%}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">SongMatch</div>
    <div class="spacer"></div>
    <button id="logoutBtn" class="tb-btn">üö™ Abmelden</button>
  </div>
  <div class="topprog"><i id="tp"></i></div>

  <div class="gate">
    <div class="card">
      <h1>Zugang</h1>
      <p class="muted">Bitte Code eingeben:</p>
      <div class="field"><input id="gateCode" type="password" placeholder="Code (z. B. 1235)" /></div>
      <button id="gateBtn" class="btn">Weiter</button>
    </div>
  </div>

  <div class="auth">
    <div class="card">
      <h2 id="authTitle">Anmelden</h2>
      <div class="field"><input id="username" placeholder="Username (ohne E-Mail)" /></div>
      <div class="field"><input id="password" type="password" placeholder="Passwort" /></div>
      <button id="loginBtn" class="btn">Anmelden</button>
      <div class="muted" style="margin-top:10px">
        <span id="authSwitchText">Noch kein Account?</span>
        <button id="authSwitch" class="btn" style="background:transparent;border:1px solid #7aa2ff;">Account erstellen</button>
      </div>
      <p id="authMsg" class="muted" style="margin-top:6px"></p>
    </div>
  </div>

  <div class="app">
    <div class="wrap">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <h2 style="margin:0">N√§chster Song</h2>
          <div class="tiny" id="progressInfo">‚Äì</div>
        </div>
        <div id="songArea" class="muted" style="min-height:420px">l√§dt Songs ‚Ä¶</div>
        <div class="playbar"><button id="playBarBtn" class="playbar-btn" title="Play/Pause">‚ñ∂Ô∏è Tippen zum Abspielen</button></div>
      </div>

      <div class="panel">
        <h2 style="margin:0 0 10px 0">Gemeinsame Playlist</h2>
        <div id="playlist" class="playlist"></div>
        <p id="plHint" class="muted" style="margin-top:6px;">Hier erscheinen Songs automatisch, sobald ihr beide ‚ù§Ô∏è geswiped habt.</p>
      </div>
    </div>
  </div>

  <script>
    // Gate
    (function(){
      var ACCESS_CODE = '1235';
      var KEY = 'songmatch:ok';
      function unlock(){ document.documentElement.classList.add('gate-ok'); try{ localStorage.setItem(KEY,'1'); }catch(_){} }
      try{ if(localStorage.getItem(KEY)==='1'){ unlock(); } }catch(_){}
      document.getElementById('gateBtn').onclick = function(){
        var code = document.getElementById('gateCode').value.trim();
        if(code===ACCESS_CODE){ unlock(); } else { alert('Falscher Code'); }
      };
    })();
  </script>

  <!-- Spotify IFrame API -->
  <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>

  <!-- Firebase compat SDKs (avoid module parsing issues) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <script>
// ==== CORE AUTH SCRIPT (isolated) ====
(function(){
  'use strict';

  // Surface errors to auth screen (this script is tiny, should always run)
  window.addEventListener('error', function(e){ try { document.getElementById('authMsg').textContent = 'JavaScript error: ' + (e && e.message || 'unknown'); } catch(_){} });
  window.addEventListener('unhandledrejection', function(e){ try { document.getElementById('authMsg').textContent = 'Runtime error: ' + (e && (e.reason && e.reason.message || e.reason) || 'unknown'); } catch(_){} });

  // Firebase init (compat)
  var firebaseConfig = {
    apiKey: "AIzaSyCOYv05V2jXiDYPjc1MlT_WdpgLfW4aJJo",
    authDomain: "songmatch-850c7.firebaseapp.com",
    projectId: "songmatch-850c7",
    storageBucket: "songmatch-850c7.firebasestorage.app",
    messagingSenderId: "139459584433",
    appId: "1:139459584433:web:df99f2c2a15cd6eed41d90"
  };
  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db   = firebase.firestore();

  // Expose for the app script
  window._sm = { auth:auth, db:db, firebase:firebase };

  // DOM refs
  var authTitle = document.getElementById('authTitle');
  var authSwitch = document.getElementById('authSwitch');
  var authSwitchText = document.getElementById('authSwitchText');
  var authMsg = document.getElementById('authMsg');
  var usernameEl = document.getElementById('username');
  var passwordEl = document.getElementById('password');
  var loginBtn = document.getElementById('loginBtn');
  var logoutBtn = document.getElementById('logoutBtn');

  function toEmail(u){ return (u||'').trim().toLowerCase() + '@sm.local'; }
  function setText(el, t){ if(el) el.textContent = t; }

  // Auth UI
  var signUpMode = false;
  authSwitch.onclick = function(){
    signUpMode = !signUpMode;
    setText(authTitle, signUpMode ? 'Account erstellen' : 'Anmelden');
    setText(loginBtn,  signUpMode ? 'Erstellen & Anmelden' : 'Anmelden');
    setText(authSwitchText, signUpMode ? 'Schon ein Account?' : 'Noch kein Account?');
    setText(authSwitch, signUpMode ? 'Anmelden' : 'Account erstellen');
  };
  try{ usernameEl.focus(); }catch(_){ }
  [usernameEl,passwordEl].forEach(function(el){ el.addEventListener('keydown', function(e){ if(e.key==='Enter'){ loginBtn.click(); } }); });

  loginBtn.onclick = function(){
    var u = (usernameEl && usernameEl.value || '').trim();
    var p = (passwordEl && passwordEl.value || '');
    if(!u || !p) { setText(authMsg, 'Username + Passwort eingeben'); return; }
    setText(authMsg, '...');
    loginBtn.disabled = true; loginBtn.textContent = signUpMode?'Erstellen & Anmelden...':'Anmelden...';
    var prom = signUpMode
      ? auth.createUserWithEmailAndPassword(toEmail(u), p).then(function(cred){
          return cred.user.updateProfile({ displayName:u }).then(function(){
            return _sm.db.collection('users').doc(cred.user.uid).set({ username:u, createdAt: _sm.firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          });
        })
      : auth.signInWithEmailAndPassword(toEmail(u), p);
    prom.then(function(){ document.documentElement.classList.add('auth-ok'); setText(authMsg, ''); })
        .catch(function(e){ setText(authMsg, 'Fehler: ' + (e && (e.code||e.message) || '')); console.error(e); })
        .finally(function(){ loginBtn.disabled = false; loginBtn.textContent = signUpMode?'Erstellen & Anmelden':'Anmelden'; });
  };
  logoutBtn.onclick = function(){ auth.signOut().then(function(){ document.documentElement.classList.remove('auth-ok'); if(usernameEl) usernameEl.value=''; if(passwordEl) passwordEl.value=''; }); };

  // Auth state ‚Üí hand over to app boot
  auth.onAuthStateChanged(function(user){
    if(!user){ document.documentElement.classList.remove('auth-ok'); return; }
    document.documentElement.classList.add('auth-ok');
    if (window.bootApp) { try{ window.bootApp(user.uid); }catch(e){ console.error(e); } }
  });
})();
</script>

<script>
// ==== APP SCRIPT (runs after auth is stable) ====
(function(){
  'use strict';

  var auth = (window._sm && window._sm.auth);
  var db   = (window._sm && window._sm.db);
  var firebase = (window._sm && window._sm.firebase);

  var songArea   = document.getElementById('songArea');
  var playlistEl = document.getElementById('playlist');
  var plHint     = document.getElementById('plHint');
  var progressInfo = document.getElementById('progressInfo');
  var playBarBtn = document.getElementById('playBarBtn');

  var spotifyApiReady = new Promise(function(resolve){ window.onSpotifyIframeApiReady = resolve; });
  var embedCtrl = null;
  function updatePlayBtn(playing){ if(!playBarBtn) return; playBarBtn.textContent = playing ? '‚è∏Ô∏è Tippen zum Pausieren' : '‚ñ∂Ô∏è Tippen zum Abspielen'; }

  function setText(el, t){ if(el) el.textContent = t; }

  function getToken(){
    return fetch('https://reasorr-github-io.vercel.app/api/token').then(function(r){ return r.json(); }).then(function(j){ return j.access_token; });
  }
  function searchTracks(token, query, limit){ if(limit==null) limit=50; var offset=Math.floor(Math.random()*10)*50; var url='https://api.spotify.com/v1/search?type=track&limit='+limit+'&offset='+offset+'&market=DE&q='+encodeURIComponent(query); return fetch(url,{ headers:{ Authorization:'Bearer '+token }}).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(d){ var items=(d.tracks&&d.tracks.items)||[]; return items.map(function(t){ return t.id; }).filter(Boolean); }); }
  function searchPlaylist(token, name){ var url='https://api.spotify.com/v1/search?type=playlist&limit=1&q='+encodeURIComponent(name); return fetch(url,{ headers:{ Authorization:'Bearer '+token }}).then(function(r){ if(!r.ok) return null; return r.json(); }).then(function(d){ return (d.playlists&&d.playlists.items&&d.playlists.items[0]&&d.playlists.items[0].id)||null; }); }
  function getPlaylistTracks(token, playlistId, max){ if(max==null) max=100; var url='https://api.spotify.com/v1/playlists/'+playlistId+'/tracks?limit='+Math.min(max,100); return fetch(url,{ headers:{ Authorization:'Bearer '+token }}).then(function(r){ if(!r.ok) return []; return r.json(); }).then(function(d){ var items=d.items||[]; return items.map(function(it){ return it&&it.track&&it.track.id; }).filter(Boolean); }); }

  function buildBatch(){
    return getToken().then(function(token){
      var pool=[];
      var chartNames=['Top 50 - Germany','Top 50 - Global','Viral 50 - Germany','Viral 50 - Global'];
      return Promise.all(chartNames.map(function(n){ return searchPlaylist(token,n).then(function(pid){ if(!pid) return []; return getPlaylistTracks(token,pid,100); }).then(function(ids){ pool=pool.concat(ids); }); }))
      .then(function(){ var queries=['pop year:2022-2025','hip hop year:2022-2025','dance year:2021-2025','rock year:2019-2025','indie year:2019-2025','house year:2020-2025','r&b year:2020-2025']; return Promise.all(queries.map(function(q){ return searchTracks(token,q,50).then(function(ids){ pool=pool.concat(ids); }); })); })
      .then(function(){ var seen={}, out=[]; for(var i=0;i<pool.length;i++){ var id=pool[i]; if(id && !seen[id]){ seen[id]=1; out.push(id); } } return out; });
    });
  }

  function poolRef(){ return db.collection('config').doc('pool'); }
  function progressRef(uid){ return db.collection('progress').doc(uid); }

  var uid=null, songs=[], index=0, history=[]; var listeningSet={};

  function updateProgress(){ var tp=document.getElementById('tp'); var p=songs.length ? (Math.min(index+1,songs.length)/songs.length*100) : 0; if(tp) tp.style.width=p+'%'; setText(progressInfo, songs.length ? ('Song '+Math.min(index+1,songs.length)+' / '+songs.length) : '‚Äì'); }

  function mountSwipeCard(trackId){
    if (!trackId) { songArea.textContent = 'üé∂ Lade Songs ‚Ä¶'; return; }
    songArea.innerHTML = ''+
      '<div class="swipe-wrap">'+
        '<div class="swipe-card" id="swipeCard">'+
          '<div class="badge like" id="badgeLike">LIKE<\/div>'+
          '<div class="badge nope" id="badgeNope">NOPE<\/div>'+
          '<div id="spotifyHost" style="width:100%;height:100%"><\/div>'+
          '<div class="gesture-top" id="gestureTop"><\/div>'+
        '<\/div>'+
      '<\/div>';

    var cardEl=document.getElementById('swipeCard');
    var badgeLike=document.getElementById('badgeLike');
    var badgeNope=document.getElementById('badgeNope');
    var gestureEl=document.getElementById('gestureTop');

    spotifyApiReady.then(function(IFrameAPI){ var host=document.getElementById('spotifyHost'); if(!IFrameAPI || !host) return; IFrameAPI.createController(host,{ uri:'spotify:track:'+trackId, width:'100%', height:'100%' }, function(controller){ embedCtrl=controller; controller.addListener('ready', function(){ updatePlayBtn(false); }); controller.addListener('playback_update', function(evt){ var data=evt&&evt.data; var playing=data && data.isPaused===false; updatePlayBtn(playing); }); }); });

    var startX=0, startY=0, dx=0, dy=0, dragging=false;
    function start(x,y){ startX=x; startY=y; dx=0; dy=0; dragging=true; cardEl.style.transition='none'; }
    function move(x,y){ if(!dragging) return; dx=x-startX; dy=y-startY; var rot=Math.max(-15, Math.min(15, dx/10)); cardEl.style.transform='translate('+dx+'px,'+dy+'px) rotate('+rot+'deg)'; var s=Math.min(1, Math.abs(dx)/90); if(dx>0){ badgeLike.style.opacity=s; badgeNope.style.opacity=0; } else if(dx<0){ badgeNope.style.opacity=s; badgeLike.style.opacity=0; } else { badgeLike.style.opacity=badgeNope.style.opacity=0; } }
    function end(){ if(!dragging) return; dragging=false; cardEl.style.transition=''; var threshold=90; if(dx>threshold){ animateDecision('right'); vote('like'); } else if(dx<-threshold){ animateDecision('left'); vote('dislike'); } else { cardEl.style.transform='translate(0px,0px) rotate(0deg)'; badgeLike.style.opacity=0; badgeNope.style.opacity=0; } }

    gestureEl.addEventListener('touchstart', function(e){ var t=e.touches[0]; start(t.clientX,t.clientY); }, {passive:true});
    gestureEl.addEventListener('touchmove',  function(e){ var t=e.touches[0]; move(t.clientX,t.clientY); }, {passive:true});
    gestureEl.addEventListener('touchend', end);
    gestureEl.addEventListener('mousedown', function(e){ start(e.clientX,e.clientY); });
    window.addEventListener('mousemove', function(e){ move(e.clientX,e.clientY); });
    window.addEventListener('mouseup', end);
  }

  function animateDecision(direction){ var cardEl=document.getElementById('swipeCard'); var badgeLike=document.getElementById('badgeLike'); var badgeNope=document.getElementById('badgeNope'); if(!cardEl) return; var offX=direction==='right'?window.innerWidth:-window.innerWidth; cardEl.style.transition='transform .25s ease, opacity .25s ease'; cardEl.style.transform='translate('+offX+'px, 0) rotate('+(direction==='right'?15:-15)+'deg)'; cardEl.style.opacity='0'; if(badgeLike) badgeLike.style.opacity=0; if(badgeNope) badgeNope.style.opacity=0; }

  function renderCurrent(){
    if (!songs.length){ songArea.textContent='üé∂ Lade Songs ‚Ä¶'; ensurePoolHasEnough(200).then(reloadSongsFromPool).then(renderCurrent); return; }
    if (index >= songs.length) { ensurePoolHasEnough(200).then(reloadSongsFromPool).then(function(){ if (index >= songs.length) index = Math.max(0, songs.length - 1); mountSwipeCard(songs[index]); updateProgress(); }); return; }
    mountSwipeCard(songs[index]); updateProgress();
  }

  function vote(val){ if(!uid || index >= songs.length) return; var id=songs[index]; history.push({ id:id, val:val }); db.collection('votes').doc(id).set({}, { merge:true }).then(function(){ var m={}; m[uid]=val; m.updatedAt=firebase.firestore.FieldValue.serverTimestamp(); return db.collection('votes').doc(id).set(m, { merge:true }); }).then(function(){ return db.runTransaction(function(tx){ return tx.get(progressRef(uid)).then(function(s){ var cur=s.exists ? (s.data().index||0) : 0; tx.set(progressRef(uid), { index: cur+1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); }); }); }).then(function(){ index=Math.min(index+1, songs.length); setTimeout(renderCurrent, 150); if(navigator.vibrate) navigator.vibrate(10); }); }

  function ensurePoolHasEnough(minCount){ if(minCount==null) minCount=200; return poolRef().get().then(function(s){ var ids=s.exists ? (s.data().ids||[]) : []; return ids; }).then(function(ids){ if(ids.length>=minCount) return ids; return buildBatch().then(function(batch){ var set={}; ids.forEach(function(id){ set[id]=1; }); batch.forEach(function(id){ if(!set[id]){ set[id]=1; ids.push(id); } }); return poolRef().set({ ids: ids, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }).then(function(){ return ids; }); }); }); }
  function reloadSongsFromPool(){ return poolRef().get().then(function(s){ songs = s.exists ? (s.data().ids||[]) : []; }); }

  if (playBarBtn) playBarBtn.onclick = function(){ try{ if(embedCtrl && embedCtrl.togglePlay){ embedCtrl.togglePlay(); } }catch(_){} };
  window.addEventListener('keydown', function(e){ var k=(e.key||'').toLowerCase(); if(k==='arrowright'){ animateDecision('right'); vote('like'); } if(k==='arrowleft'){ animateDecision('left'); vote('dislike'); } if(k==='p'){ e.preventDefault(); if(playBarBtn) playBarBtn.click(); } });

  function setupPlaylistListenersFor(ids){ for(var i=0;i<ids.length;i++){ (function(id){ if(listeningSet[id]) return; listeningSet[id]=1; db.collection('votes').doc(id).onSnapshot(function(snap){ if(!snap.exists) return; var data=snap.data()||{}; var vals=[]; for(var k in data){ if(data[k]==='like'||data[k]==='dislike') vals.push(data[k]); } if(vals.length>=2 && vals.every(function(v){return v==='like';})){ var elId='pl-'+id; if(!document.getElementById(elId)){ var iframe=document.createElement('iframe'); iframe.id=elId; iframe.className='embed-small'; iframe.src='https://open.spotify.com/embed/track/'+id; playlistEl.appendChild(iframe); if(plHint) plHint.style.display='none'; } } }); })(ids[i]); } }

  // Expose app boot to auth script
  window.bootApp = function(newUid){ uid=newUid; progressRef(uid).get().then(function(s){ index=s.exists ? (s.data().index||0) : 0; }).then(function(){ ensurePoolHasEnough(200).then(reloadSongsFromPool).then(function(){ setupPlaylistListenersFor(songs); renderCurrent(); }); }); };

})();
</script>
</body>
</html>
